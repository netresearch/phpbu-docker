name: Container Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  smoke-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3

      - name: Build test image
        uses: docker/bake-action@5be5f02ff8819ecd3092ea6b2e6261c31774f2b4 # v6
        with:
          targets: ci
          load: true

      - name: Test phpbu version
        run: |
          docker run --rm phpbu:ci --version
          docker run --rm phpbu:ci --version | grep -E "^phpbu [0-9]+\.[0-9]+\.[0-9]+"

      - name: Test phpbu help
        run: docker run --rm phpbu:ci --help | grep -q "backup"

      - name: Test non-root user
        run: |
          USER=$(docker run --rm --entrypoint id phpbu:ci -u)
          test "$USER" = "1000" || (echo "Expected UID 1000, got $USER" && exit 1)

      - name: Test read-only filesystem compatibility
        run: |
          docker run --rm --read-only --tmpfs /tmp:mode=1777 phpbu:ci --version

      - name: Test healthcheck command
        run: |
          # Verify healthcheck command works (same as HEALTHCHECK in Dockerfile)
          docker run --rm --entrypoint /app/vendor/bin/phpbu phpbu:ci --version

      - name: Test simulate mode
        run: |
          # Create a simple test config without external adapters
          cat > /tmp/test-config.json <<'EOF'
          {
            "verbose": true,
            "backups": [
              {
                "name": "Test backup",
                "source": {
                  "type": "tar",
                  "options": {
                    "path": "/app"
                  }
                },
                "target": {
                  "dirname": "/backups",
                  "filename": "test-%Y%m%d.tar"
                }
              }
            ]
          }
          EOF
          mkdir -p /tmp/backups
          # Set permissions for phpbu user (UID 1000)
          chmod 777 /tmp/backups
          docker run --rm \
            -v /tmp/test-config.json:/config/backup.json:ro \
            -v /tmp/backups:/backups \
            phpbu:ci \
            --configuration=/config/backup.json \
            --simulate

  structure-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3

      - name: Build test image
        uses: docker/bake-action@5be5f02ff8819ecd3092ea6b2e6261c31774f2b4 # v6
        with:
          targets: ci
          load: true

      - name: Install container-structure-test
        run: |
          curl -LO https://github.com/GoogleContainerTools/container-structure-test/releases/download/v1.19.3/container-structure-test-linux-amd64
          echo "fa0fa333bb6ba5c14065e7468d2904f5c82d021d7e1c763c9a45c5f2fbe9ff5f  container-structure-test-linux-amd64" | sha256sum -c -
          chmod +x container-structure-test-linux-amd64
          sudo mv container-structure-test-linux-amd64 /usr/local/bin/container-structure-test

      - name: Run structure tests
        run: container-structure-test test --image phpbu:ci --config tests/container-structure-test.yaml
